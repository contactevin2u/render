<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Worldclass Order Suite – Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    .tab-active { border-bottom: 2px solid currentColor; font-weight: 600; }
    .btn {  }
    .card {  }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill {  }
  </style>
  <script>
    // Minimal Tailwind utilities for .btn/.card using arbitrary values
    document.addEventListener('DOMContentLoaded', () => {
      const s = document.createElement('style');
      s.textContent = `
        .btn{padding:0.5rem 0.75rem;border-radius:0.75rem;box-shadow:0 1px 2px rgba(0,0,0,0.05);border:1px solid rgba(0,0,0,0.1);transition:transform .08s ease}
        .btn:hover{transform:translateY(-1px)}
        .card{border-radius:1rem;box-shadow:0 4px 10px rgba(0,0,0,0.05);padding:1rem;border:1px solid rgba(0,0,0,0.1);background:white}
        .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .5rem;border-radius:9999px;border:1px solid rgba(0,0,0,0.12);font-size:.75rem}
      `;
      document.head.appendChild(s);
    });
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between gap-4 mb-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-indigo-600/10 grid place-items-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-600"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        </div>
        <div>
          <h1 class="text-xl font-bold">Worldclass Order Suite – Admin</h1>
          <p class="text-sm text-slate-600">Intake → Orders → Payments → Schedules → Outstanding</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input id="apiBase" class="px-3 py-2 rounded-xl border shadow-sm w-[320px]" placeholder="API Base URL (e.g. http://localhost:10000)" />
        <button class="btn" onclick="saveApiBase()">Save</button>
        <button class="btn" onclick="healthCheck()">Health</button>
      </div>
    </header>

    <nav class="flex gap-6 border-b border-black/10 mb-4">
      <button class="pb-3 tab-active" data-tab="intake" onclick="switchTab(event)">Intake</button>
      <button class="pb-3" data-tab="orders" onclick="switchTab(event)">Orders</button>
      <button class="pb-3" data-tab="payments" onclick="switchTab(event)">Payments</button>
      <button class="pb-3" data-tab="schedules" onclick="switchTab(event)">Schedules</button>
      <button class="pb-3" data-tab="outstanding" onclick="switchTab(event)">Outstanding</button>
      <button class="pb-3" data-tab="tools" onclick="switchTab(event)">Tools</button>
    </nav>

    <!-- Intake Tab -->
    <section id="tab-intake" class="grid gap-4">
      <div class="card grid-2">
        <div>
          <h2 class="font-semibold mb-2">Paste chat/text</h2>
          <textarea id="intakeText" rows="12" class="w-full rounded-xl border p-3 mono" placeholder="e.g. Sewa katil hospital 1 unit RM150/bulan selama 3 bulan, deposit RM100. Nama Ali, phone 011-1234 5678."></textarea>
          <div class="mt-3 flex gap-2">
            <button class="btn" onclick="parseIntake(false)">Parse only</button>
            <button class="btn" onclick="parseIntake(true)">Parse & Create Order</button>
          </div>
        </div>
        <div>
          <h2 class="font-semibold mb-2">Parsed JSON</h2>
          <pre id="parsedOut" class="mono text-xs bg-slate-900 text-slate-100 p-3 rounded-xl h-[320px] overflow-auto">{}</pre>
          <div class="mt-3">
            <button class="btn" onclick="jsonToOrderDraft()">Use parsed → Order draft</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="font-semibold mb-3">Order draft</h2>
        <div class="grid md:grid-cols-2 gap-3">
          <input id="od_name" class="px-3 py-2 rounded-xl border" placeholder="Customer name" />
          <input id="od_phone" class="px-3 py-2 rounded-xl border" placeholder="Customer phone" />
          <input id="od_addr" class="px-3 py-2 rounded-xl border md:col-span-2" placeholder="Customer address (optional)" />
          <select id="od_type" class="px-3 py-2 rounded-xl border">
            <option value="outright_purchase">Outright purchase</option>
            <option value="instalment">Instalment</option>
            <option value="rent">Rent</option>
          </select>
        </div>
        <div class="mt-3">
          <table class="w-full text-sm">
            <thead class="text-left"><tr class="text-slate-600"><th class="py-1">Code</th><th>Description</th><th class="w-16">Qty</th><th class="w-28">Unit MYR</th><th class="w-10"></th></tr></thead>
            <tbody id="od_items"></tbody>
          </table>
          <div class="mt-2 flex gap-2">
            <button class="btn" onclick="addItemRow()">Add item</button>
            <button class="btn" onclick="createOrder()">Create order</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Orders Tab -->
    <section id="tab-orders" class="hidden grid gap-4">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Recent orders</h2>
          <button class="btn" onclick="loadOrders()">Refresh</button>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr><th>Code</th><th>Type</th><th>Status</th><th class="text-right">Total (MYR)</th><th>Customer</th><th>Phone</th><th>Created</th><th></th></tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 class="font-semibold mb-2">Add payment</h3>
          <div class="grid gap-2">
            <input id="tx_order_id" class="px-3 py-2 rounded-xl border" placeholder="order_id (select from list)"/>
            <select id="tx_type" class="px-3 py-2 rounded-xl border">
              <option value="payment">payment</option>
              <option value="deposit">deposit</option>
              <option value="refund">refund</option>
            </select>
            <input id="tx_amount" type="number" step="0.01" class="px-3 py-2 rounded-xl border" placeholder="amount MYR"/>
            <input id="tx_method" class="px-3 py-2 rounded-xl border" placeholder="method (cash/bank/...)"/>
            <input id="tx_ref" class="px-3 py-2 rounded-xl border" placeholder="reference (optional)"/>
            <input id="tx_notes" class="px-3 py-2 rounded-xl border" placeholder="notes (optional)"/>
            <button class="btn" onclick="addTransaction()">Submit payment</button>
          </div>
        </div>
        <div class="card">
          <h3 class="font-semibold mb-2">Add schedule</h3>
          <div class="grid gap-2">
            <input id="sc_order_id" class="px-3 py-2 rounded-xl border" placeholder="order_id (select from list)"/>
            <select id="sc_type" class="px-3 py-2 rounded-xl border">
              <option value="rent">rent</option>
              <option value="instalment">instalment</option>
            </select>
            <select id="sc_freq" class="px-3 py-2 rounded-xl border">
              <option value="monthly">monthly</option>
              <option value="weekly">weekly</option>
            </select>
            <input id="sc_amount" type="number" step="0.01" class="px-3 py-2 rounded-xl border" placeholder="amount MYR"/>
            <input id="sc_due" type="date" class="px-3 py-2 rounded-xl border"/>
            <input id="sc_cycles" type="number" class="px-3 py-2 rounded-xl border" placeholder="total cycles (optional)"/>
            <input id="sc_grace" type="number" class="px-3 py-2 rounded-xl border" placeholder="grace days (default 3)"/>
            <button class="btn" onclick="addSchedule()">Create schedule</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Schedules/Outstanding Tab -->
    <section id="tab-outstanding" class="hidden grid gap-4">
      <div class="card">
        <div class="flex items-center gap-2 flex-wrap mb-3">
          <select id="os_type" class="px-3 py-2 rounded-xl border">
            <option value="">Any type</option>
            <option value="rent">rent</option>
            <option value="instalment">instalment</option>
          </select>
          <label class="flex items-center gap-2"><input id="os_overdue_only" type="checkbox" class="scale-110"/> <span>Overdue only</span></label>
          <input id="os_due_before" type="date" class="px-3 py-2 rounded-xl border" />
          <button class="btn" onclick="loadOutstanding()">Run</button>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-600"><tr><th>Order</th><th>Customer</th><th>Type</th><th>Freq</th><th class="text-right">Amount (MYR)</th><th>Next due</th><th>Phone</th></tr></thead>
            <tbody id="osBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Payments Tab -->
    <section id="tab-payments" class="hidden">
      <div class="card grid-2">
        <div>
          <h3 class="font-semibold mb-2">Quick payment</h3>
          <div class="grid gap-2">
            <input id="qp_order_id" class="px-3 py-2 rounded-xl border" placeholder="order_id"/>
            <input id="qp_amount" type="number" step="0.01" class="px-3 py-2 rounded-xl border" placeholder="amount MYR"/>
            <button class="btn" onclick="quickPay()">Add payment</button>
          </div>
        </div>
        <div>
          <p class="text-sm text-slate-600">Use the Orders tab to copy an <code class="mono">order_id</code> from the list.</p>
        </div>
      </div>
    </section>

    <!-- Tools Tab -->
    <section id="tab-tools" class="hidden grid gap-4">
      <div class="card grid md:grid-cols-3 gap-3">
        <div>
          <h3 class="font-semibold mb-2">Import API base presets</h3>
          <div class="flex gap-2 flex-wrap">
            <button class="btn" onclick="setApi('http://localhost:10000')">localhost:10000</button>
            <button class="btn" onclick="setApi('https://render-2siv.onrender.com')">render prod</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Copy JSON helpers</h3>
          <div class="flex gap-2 flex-wrap">
            <button class="btn" onclick="copyParsedAsOrder()">Copy parsed → /api/orders body</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Quick checks</h3>
          <div class="flex gap-2 flex-wrap">
            <button class="btn" onclick="healthCheck()">/api/health</button>
            <button class="btn" onclick="dbHealthCheck()">/api/db-health</button>
          </div>
        </div>
      </div>
    </section>

    <div id="toast" class="fixed bottom-4 right-4 hidden"></div>
  </div>

  <script>
    // --- tiny UI helpers ---
    function $(id){ return document.getElementById(id); }
    function toast(msg, ok=true){
      const el = $("toast");
      el.innerHTML = \`<div class="card bg-\${ok?'emerald':'rose'}-50 border-\${ok?'emerald':'rose'}-200"><div class="flex items-center gap-2"><div class="pill">\${ok?'✅':'⚠️'}</div><div>\${msg}</div></div></div>\`;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 2600);
    }
    function apiBase(){ return ($("apiBase").value || localStorage.getItem('apiBase') || '').replace(/\/$/,''); }
    function saveApiBase(){ localStorage.setItem('apiBase', $("apiBase").value); toast('Saved base: '+apiBase()); }
    function setApi(v){ $("apiBase").value = v; saveApiBase(); }
    function switchTab(e){
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('tab-active'));
      e.target.classList.add('tab-active');
      const tab = e.target.getAttribute('data-tab');
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $("tab-"+tab).classList.remove('hidden');
      if(tab==='orders') loadOrders();
      if(tab==='outstanding') loadOutstanding();
    }

    // --- fetch wrapper ---
    async function jfetch(path, opts={}){
      const base = apiBase();
      if(!base){ throw new Error('Set API Base URL first (top right)'); }
      const url = base + path;
      const res = await fetch(url, { headers: { 'Content-Type':'application/json' }, ...opts });
      const text = await res.text();
      let data; try { data = text ? JSON.parse(text) : null; } catch{ data = { raw:text }; }
      if(!res.ok) throw new Error(data?.error || data?.message || (res.status+': '+text));
      return data;
    }

    // --- Intake ---
    async function parseIntake(create){
      try{
        const text = $("intakeText").value.trim();
        if(!text) return toast('Paste some text first', false);
        const qs = create ? '?create=true' : '?create=false';
        const data = await jfetch('/api/intake/parse'+qs, { method:'POST', body: JSON.stringify({ text })});
        $("parsedOut").textContent = JSON.stringify(data, null, 2);
        toast(create?\`Parsed & created: \${data?.order_code || ''}\`:'Parsed');
        if(create) loadOrders();
      }catch(e){ toast('Parse failed: '+e.message, false); }
    }

    function jsonToOrderDraft(){
      let v; try { v = JSON.parse($("parsedOut").textContent || '{}'); } catch { v = {}; }
      const p = v.parsed || v; // accept either shape
      $("od_name").value = p.customer_name||'';
      $("od_phone").value = p.customer_phone_primary||'';
      $("od_addr").value = p.customer_address||'';
      $("od_type").value = p.order_type||'outright_purchase';
      $("od_items").innerHTML = '';
      (p.line_items||[]).forEach(addItemRowFrom);
    }

    function addItemRowFrom(li){
      addItemRow(li.product_code||'', li.description||'', li.qty||1, li.unit_price_myr||0);
    }
    function addItemRow(code='', desc='', qty=1, unit=0){
      const id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random().toString(16).slice(2)));
      const tr = document.createElement('tr');
      tr.innerHTML = \`
        <td class="py-1"><input data-k="product_code" data-id="\${id}" class="w-28 px-2 py-1 rounded border" value="\${String(code)}"></td>
        <td><input data-k="description" data-id="\${id}" class="w-full px-2 py-1 rounded border" value="\${String(desc)}"></td>
        <td><input data-k="qty" data-id="\${id}" type="number" step="1" min="1" class="w-16 px-2 py-1 rounded border text-right" value="\${Number(qty)}"></td>
        <td><input data-k="unit_price_myr" data-id="\${id}" type="number" step="0.01" class="w-28 px-2 py-1 rounded border text-right" value="\${Number(unit)}"></td>
        <td><button class="text-rose-600" onclick="this.closest('tr').remove()">✕</button></td>\`;
      $("od_items").appendChild(tr);
    }

    async function createOrder(){
      try{
        const line_items = Array.from(document.querySelectorAll('#od_items [data-id]')).reduce((acc, el)=>{
          const id = el.getAttribute('data-id');
          if(!acc[id]) acc[id] = {};
          acc[id][el.getAttribute('data-k')] = (el.type==='number') ? Number(el.value) : el.value;
          return acc; }, {});
        const items = Object.values(line_items).filter(x=>x.description && Number(x.qty)>0).map(x=>({
          product_code: x.product_code||'MANUAL-1', description: x.description, qty: Number(x.qty)||1, unit_price_myr: Number(x.unit_price_myr)||0
        }));
        const body = {
          customer_name: $("od_name").value.trim(),
          customer_phone_primary: $("od_phone").value.trim(),
          customer_address: $("od_addr").value.trim()||undefined,
          order_type: $("od_type").value,
          line_items: items
        };
        if(!body.customer_name || !body.customer_phone_primary || !body.order_type || items.length===0){
          return toast('Missing required fields', false);
        }
        const r = await jfetch('/api/orders', { method:'POST', body: JSON.stringify(body) });
        toast('Order created: '+(r.order_code||''));
        loadOrders();
      }catch(e){ toast('Create failed: '+e.message, false); }
    }

    // --- Orders list ---
    async function loadOrders(){
      try{
        const rows = await jfetch('/api/orders');
        const tb = $("ordersBody"); tb.innerHTML = '';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td class="py-1 mono">\${r.order_code}</td>
            <td>\${r.order_type}</td>
            <td><span class="pill">\${r.status}</span></td>
            <td class="text-right mono">\${Number(r.total_myr||0).toFixed(2)}</td>
            <td>\${r.customer_name||''}</td>
            <td class="mono">\${r.phone_primary||''}</td>
            <td class="text-slate-600 text-xs">\${new Date(r.created_at).toLocaleString()}</td>
            <td>
              <button class="btn text-xs" onclick="copyId('\${r.id}','\${r.order_code}')">Copy IDs</button>
              <button class="btn text-xs" onclick="prefillFor(r)">Use</button>
            </td>\`;
          tb.appendChild(tr);
        });
      }catch(e){ toast('Load orders failed: '+e.message, false); }
    }
    function copyId(id, code){ navigator.clipboard.writeText(id); toast('Copied order_id: '+id); $("tx_order_id").value = id; $("sc_order_id").value = id; $("qp_order_id").value = id; }
    function prefillFor(r){ $("od_name").value = r.customer_name||''; $("od_type").value = r.order_type; }

    // --- Payments ---
    async function addTransaction(){
      try{
        const body = {
          order_id: $("tx_order_id").value.trim(),
          type: $("tx_type").value,
          amount_myr: Number($("tx_amount").value),
          method: $("tx_method").value.trim()||undefined,
          reference: $("tx_ref").value.trim()||undefined,
          notes: $("tx_notes").value.trim()||undefined,
        };
        if(!body.order_id || !Number.isFinite(body.amount_myr)) return toast('order_id & amount_myr required', false);
        await jfetch('/api/transactions', { method:'POST', body: JSON.stringify(body) });
        toast('Payment added');
      }catch(e){ toast('Payment failed: '+e.message, false); }
    }
    async function quickPay(){ $("tx_order_id").value = $("qp_order_id").value; $("tx_type").value = 'payment'; $("tx_amount").value = $("qp_amount").value; addTransaction(); }

    // --- Schedules ---
    async function addSchedule(){
      try{
        const body = {
          order_id: $("sc_order_id").value.trim(),
          schedule_type: $("sc_type").value,
          frequency: $("sc_freq").value,
          amount_myr: Number($("sc_amount").value),
          total_cycles: $("sc_cycles").value ? Number($("sc_cycles").value) : undefined,
          next_due_date: $("sc_due").value,
          grace_days: $("sc_grace").value ? Number($("sc_grace").value) : undefined,
        };
        if(!body.order_id || !body.frequency || !body.amount_myr || !body.next_due_date) return toast('Missing required schedule fields', false);
        await jfetch('/api/schedules', { method:'POST', body: JSON.stringify(body) });
        toast('Schedule created');
      }catch(e){ toast('Schedule failed: '+e.message, false); }
    }

    // --- Outstanding ---
    async function loadOutstanding(){
      try{
        const params = new URLSearchParams();
        const type = $("os_type").value; if(type) params.set('type', type);
        const due = $("os_due_before").value; if(due) params.set('due_before', due);
        if($("os_overdue_only").checked) params.set('overdue_only', 'true');
        const rows = await jfetch('/api/outstanding?'+params.toString());
        const tb = $("osBody"); tb.innerHTML = '';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td class="mono">\${r.order_code}</td>
            <td>\${r.customer_name}</td>
            <td>\${r.schedule_type}</td>
            <td>\${r.frequency}</td>
            <td class="text-right mono">\${(Number(r.amount_myr||0)).toFixed(2)}</td>
            <td>\${r.next_due_date}</td>
            <td class="mono">\${r.phone_primary||''}</td>\`;
          tb.appendChild(tr);
        });
      }catch(e){ toast('Outstanding failed: '+e.message, false); }
    }

    // --- Health ---
    async function healthCheck(){ try{ const r = await jfetch('/api/health'); toast('API OK '+(r.time||'')); } catch(e){ toast('Health failed: '+e.message, false); } }
    async function dbHealthCheck(){ try{ const r = await jfetch('/api/db-health'); toast('DB OK '+(r.db_time||'')); } catch(e){ toast('DB failed: '+e.message, false); } }

    // --- tools ---
    function copyParsedAsOrder(){
      let v; try { v = JSON.parse($("parsedOut").textContent || '{}'); } catch { v = {}; }
      const p = v.parsed || v;
      const order = {
        customer_name: p.customer_name||'',
        customer_phone_primary: p.customer_phone_primary||'',
        customer_address: p.customer_address||undefined,
        order_type: p.order_type||'outright_purchase',
        line_items: (p.line_items||[]).map((li,i)=>({
          product_code: li.product_code || 'PARSED-'+(i+1),
          description: li.description,
          qty: Number(li.qty||1),
          unit_price_myr: Number(li.unit_price_myr||0)
        }))
      }
      const s = JSON.stringify(order, null, 2);
      navigator.clipboard.writeText(s); toast('Copied /api/orders body');
    }

    // init
    (function init(){
      const saved = localStorage.getItem('apiBase');
      if(saved) $("apiBase").value = saved; else $("apiBase").value = 'http://localhost:10000';
      $("os_due_before").valueAsDate = new Date();
    })();
  </script>
</body>
</html>
